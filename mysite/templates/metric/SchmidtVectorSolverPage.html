{% extends "csstemplate.html" %}

{% load static %}

{% block head %}
<title> 计算二次型标准形 </title>
{% endblock head %}

{% block body %}

<!-- 主内容 -->
<main>
  <div class="container">
    <div class="row">
      <!-- 内容 -->
      <div role="main" class="col-md-9">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">向量正交化</h3>
          </div>

          <div class="panel-body">
            <form class="form-horizontal">
              <label for="matrix" class="col-md-2 control-label">输入向量</label>
              <div class="col-md-8">
                <input type="text" class="form-control" id="matrix" value="[[1,1,0,0],[1,0,1,0],[-1,0,0,1],[1,-1,-1,1]]">
              </div>
              <div class="col-md-1">
                <button type="button" class="btn btn-default" id="submit">提交</button>
              </div>
            </form>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">问题解答</h3>
          </div>

          <div class="panel-body" id="answer-area">

            <div class="panel panel-default" id="start_area" hidden>
              <div class="panel-body" id="start_vector">
              </div>
            </div>

            <div id="course_area"></div>
            
            <div class="panel panel-default" id="norm_area" hidden>
              <div class="panel-body" id="norm_vector">
              </div>
            </div>

          </div>
        </div>

      </div>

      <!-- 侧边栏 -->
      <div class="col-md-3" role="complementary">
        <ul class="list-group">
          <li class="list-group-item"><h3><a href="#">快捷导航</a></h3></li>
          <li class="list-group-item"><a href="#">行列式</a></li>
          <li class="list-group-item"><a href="#">线性方程</a></li>
          <li class="list-group-item"><a href="#">特征值与特征向量</a></li>
          <li class="list-group-item"><a href="#">二次型</a></li>
        </ul>
      </div>
      
    </div>
  </div>
</main>

<!-- 答案生成代码 -->
<script>
  const csrftoken = docCookies.getItem('csrftoken');
  const btn = document.getElementById('submit');
  const course_area = document.getElementById('course_area');

  function create_courese(data, i) {
    // 生成每行求正交向量的过程
    let outerdiv = document.createElement('div');
    let innerdiv = document.createElement('div');
    outerdiv.className = 'panel panel-default';
    innerdiv.className = 'panel-body';
    outerdiv.appendChild(innerdiv);

    let course = `\\varepsilon_{${i+1}} = \\alpha_{${i+1}}`;
    for(let j = 0; j < i; j++) {
      course = course + `- \\frac{(\\alpha_{${i+1}}, \\varepsilon_{${j+1}})}{(\\varepsilon_{${i+1}}, \\varepsilon_{${j+1}})} \\varepsilon_{${j+1}}`;
    }
    course = course + `= \\alpha_{${i+1}}`;
    for(let j = 0; j < i; j++) {
      if (data.coef[i][j].charAt(0) == '-') {
        // 防止出现连续的两个负号
        course = course + `+ ${data.coef[i][j].substring(1)}\\varepsilon_{${j+1}}`;
      } else {
        course = course + `- ${data.coef[i][j]}\\varepsilon_{${j+1}}`;
      }
      
    }
    course = course + `= ${data.vecs[i]}`;
    innerdiv.innerHTML = `$$${course}$$`;

    course_area.appendChild(outerdiv);
  }

  function myCatch(value) {
    var myInit = { 
      method: 'POST',
      mode: 'cors',
      headers: {'X-csrftoken':csrftoken},
      body: JSON.stringify({matrix: value}),
    };
    var myRequest = new Request("{% url 'SchmidtVectorSolver' %}", myInit);
    fetch(myRequest)
    .then(response => response.json())
    .then(data => {
      console.log(data);

      let course = '';
      for(let i = 0; i < data.mat.length; i++) {
        course = course + `\\alpha_{${i+1}} = ${data.mat[i]},`;
      }
      document.getElementById('start_vector').innerHTML = `初始向量：$${course.substring(0, course.length - 1)}$`;
      document.getElementById('start_area').hidden = false;

      for(let i = 0; i < data.vecs.length; i++) {
        create_courese(data, i)
      }

      course = '';
      for(let i = 0; i < data.norm_vecs.length; i++) {
        course = course + `\\varepsilon_{${i+1}}' = ${data.norm_vecs[i]},`;
      }
      document.getElementById('norm_vector').innerHTML = `单位化后得：$${course.substring(0, course.length - 1)}$`;
      document.getElementById('norm_area').hidden = false;

      MathJax.typeset();
    });
  }

  btn.addEventListener('click', () => {
    // 先删除先前js生成的元素
    var childs = course_area.childNodes; 
    for(var i = childs.length - 1; i >= 0; i--) { 
      course_area.removeChild(childs[i]); 
    }

    var matrix = document.getElementById('matrix').value;
    myCatch(matrix);
  })
</script>

{% endblock body %}